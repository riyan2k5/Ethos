name: Deployment Pipeline

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: []  # Can add dependencies like build-container job
    environment: ${{ github.event.inputs.environment && github.event.inputs.environment != '' && github.event.inputs.environment || 'staging' }}
    permissions:
      contents: read
      packages: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run pre-deployment tests
      run: |
        pytest tests/ -v
    
    - name: Run data validation
      run: |
        if [ -f "data/spotify_data_reduced.csv" ]; then
          python scripts/validate_data.py \
            --data-path "data/spotify_data_reduced.csv" \
            --target-column "genre"
        else
          echo "‚ö†Ô∏è  Data file not found, skipping validation"
        fi
    
    - name: Deploy to staging
      if: github.event.inputs.environment == 'staging' || (github.event.inputs.environment == '' && github.ref == 'refs/heads/main')
      run: |
        echo "üöÄ Deploying to staging environment..."
        # Add your staging deployment commands here
        # Examples:
        # - kubectl apply -f k8s/staging/
        # - docker-compose -f docker-compose.staging.yml up -d
        # - terraform apply -var-file=staging.tfvars
        echo "‚úÖ Staging deployment completed"
    
    - name: Deploy to production
      if: github.event.inputs.environment == 'production' || startsWith(github.ref, 'refs/tags/v')
      run: |
        echo "üöÄ Deploying to production environment..."
        # Add your production deployment commands here
        # Examples:
        # - kubectl apply -f k8s/production/
        # - docker-compose -f docker-compose.prod.yml up -d
        # - terraform apply -var-file=production.tfvars
        echo "‚úÖ Production deployment completed"
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        # Add smoke test commands here
        # Examples:
        # - curl -f https://staging.example.com/health || exit 1
        # - pytest tests/smoke_tests.py
        echo "‚úÖ Smoke tests passed"
    
    - name: Set environment variable
      id: set-env
      run: |
        if [ -z "${{ github.event.inputs.environment }}" ]; then
          echo "env=staging" >> $GITHUB_OUTPUT
        else
          echo "env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Notify deployment status
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const status = '${{ job.status }}';
          const environment = '${{ steps.set-env.outputs.env }}';
          const message = status === 'success' 
            ? `‚úÖ Deployment to ${environment} completed successfully`
            : `‚ùå Deployment to ${environment} failed`;
          
          github.rest.repos.createDispatchEvent({
            owner: context.repo.owner,
            repo: context.repo.repo,
            event_type: 'deployment',
            client_payload: {
              status: status,
              environment: environment,
              message: message
            }
          });
