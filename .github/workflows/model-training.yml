name: Model Training

on:
  push:
    branches: [ main ]
    paths:
      - 'ml/**'
      - 'preprocessing/**'
      - 'api/**'
  workflow_dispatch:
    inputs:
      train_on_production:
        description: 'Train on production data'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Run training daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  train-model:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set up database connection
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        if [ -z "$DATABASE_URL" ]; then
          echo "❌ ERROR: DATABASE_URL secret is not set in GitHub repository secrets"
          echo "Please add DATABASE_URL to your repository secrets:"
          echo "1. Go to Settings > Secrets and variables > Actions"
          echo "2. Click 'New repository secret'"
          echo "3. Name: DATABASE_URL"
          echo "4. Value: your_postgresql_connection_string"
          exit 1
        else
          echo "✅ DATABASE_URL is set (hidden for security)"
        fi
    
    - name: Test database connection
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        python api/test_db_connection.py
    
    - name: Train model
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        cd ml
        python train_genre_model.py
      continue-on-error: false
    
    - name: Save model artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: model-artifacts
        path: |
          ml/models/
          ml/*.pkl
        retention-days: 30
        if-no-files-found: warn
    
    - name: Save training metrics
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: training-metrics
        path: |
          ml/metrics/
          ml/*.json
        retention-days: 30
        if-no-files-found: warn
    
    - name: Comment PR with training results
      if: github.event_name == 'pull_request' && success()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '✅ Model training completed successfully!'
          })
