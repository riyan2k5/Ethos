name: Model Training

on:
  push:
    branches: [ main ]
    paths:
      - 'ml/**'
      - 'preprocessing/**'
      - 'data/**'
  workflow_dispatch:
    inputs:
      train_on_production:
        description: 'Train on production data'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Run training weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'

jobs:
  train-model:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download or prepare training data
      run: |
        # Check if data file exists
        if [ ! -f "data/spotify_data_reduced.csv" ]; then
          echo "⚠️  Training data not found. Creating sample data for testing..."
          python -c "
          import pandas as pd
          import numpy as np
          np.random.seed(42)
          n_samples = 1000
          df = pd.DataFrame({
              'artist_name': ['Artist' + str(i) for i in range(n_samples)],
              'track_name': ['Track' + str(i) for i in range(n_samples)],
              'track_id': ['id_' + str(i) for i in range(n_samples)],
              'genre': np.random.choice(['Pop', 'Rock', 'Jazz', 'Electronic', 'Hip-Hop'], n_samples),
              'danceability': np.random.uniform(0, 1, n_samples),
              'energy': np.random.uniform(0, 1, n_samples),
              'acousticness': np.random.uniform(0, 1, n_samples),
              'instrumentalness': np.random.uniform(0, 1, n_samples),
              'loudness': np.random.uniform(-20, 0, n_samples),
              'liveness': np.random.uniform(0, 1, n_samples),
              'valence': np.random.uniform(0, 1, n_samples),
              'tempo': np.random.uniform(60, 200, n_samples),
              'key': np.random.randint(0, 12, n_samples),
              'year': np.random.randint(2000, 2023, n_samples),
              'duration_ms': np.random.randint(120000, 300000, n_samples)
          })
          df.to_csv('data/spotify_data_reduced.csv', index=False)
          print(f'Sample training data created with {n_samples} samples')
          "
        fi
    
    - name: Run data validation before training
      run: |
        python scripts/validate_data.py \
          --data-path "data/spotify_data_reduced.csv" \
          --target-column "genre"
    
    - name: Train model
      run: |
        cd ml
        python train_genre_model.py
      continue-on-error: false
    
    - name: Save model artifacts
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: model-artifacts
        path: |
          ml/models/
          ml/*.pkl
        retention-days: 30
        if-no-files-found: warn
    
    - name: Save training metrics
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: training-metrics
        path: |
          ml/metrics/
          ml/*.json
        retention-days: 30
        if-no-files-found: warn
    
    - name: Comment PR with training results
      if: github.event_name == 'pull_request' && success()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '✅ Model training completed successfully!'
          })
